<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="/src/js/snake.js"></script>
    <title>Document</title>
</head>

<body>
    <canvas id="canvas" width="700" height="700"></canvas>

    <script>
        let canvas = document.getElementById("canvas");
        let ctx = canvas.getContext('2d');

        let marker = {
            x: 350,
            y: 0
        };
        let place = false;
        let sand = [];
        let direction = 'NONE';

        setInterval(update, 10);
        document.addEventListener('keydown', keyDown);

        render();

        function render() {
            //backdrop
            ctx.fillStyle = "black";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            //marker
            renderMarker(marker.x, marker.y);

            //sand
            ctx.fillStyle = "yellow";
            renderSand();

            requestAnimationFrame(render);
        }

        function renderMarker(x, y) {
            ctx.fillStyle = "white";
            ctx.fillRect(marker.x, marker.y, 25, 25);
        }

        function renderSand() {
            sand.forEach(e => {
                ctx.fillRect(e.x, e.y, 1, 1);
            });
        }

        function update() {
            updateDir();
            fallSand();
        }

        function fallSand() {
            sand.forEach(e => {
                if(e.y+1 < canvas.height){
                    if(findSand(e.x, e.y+1) == null){
                        e.y++;
                    }
                }
            });
        }

        function findSand(x, y){
            sand.forEach(e => {
                if(e.x == x && e.y == y) {
                    return e;
                }
            });
            return null;
        }

        function placeSand(x, y) {
            sand = [
                {
                    x: x,
                    y: y
                }, ...sand
            ];
        }

        function updateDir() {
            if (direction == 'LEFT') {
                marker.x -= 3;
                direction = 'NONE';
            }
            if (direction == 'RIGHT') {
                marker.x += 3;
                direction = 'NONE';
            }
            if (place) {
                placeSand(marker.x, marker.y);
                place = false;
            }
        }
        function keyDown(e) {
            if (e.keyCode == 32) {
                place = true;
            }
            if (e.keyCode == 37) {
                direction = 'LEFT';
            }
            if (e.keyCode == 39) {
                direction = 'RIGHT';
            }
        }


    </script>
</body>

</html>